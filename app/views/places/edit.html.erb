<h3>投稿編集</h3>

<%= render "shared/error", obj: @place %>

<%= form_with model: @place do |f| %>
  <table>
    <tr>
      <th><%= f.label :name,"登録名" %></th>
      <td><%= f.text_field :name %></td>
    </tr>
    <tr>
      <th><%= f.label :memo,"memo" %></th>
      <td><%= f.text_field :memo %></td>
    </tr>
  </table>

  <div>
    <ul>
      <li><%= f.submit "編集を完了する" %></li>
      <li><%= link_to "ユーザー情報一覧に戻る", :users %></li>
    </ul>
  </div>
  <%= f.hidden_field :latitude,:value => @place.latitude, id: :lat %>
  <%= f.hidden_field :longitude,:value => @place.longitude, id: :lng %>
<% end %>

<h2>Map</h2>

<input id="address" type="textbox" value=<%= @place.name %>>
<input type="button" value="検索" onclick="codeAddress()">
<p>ピンをドラック＆ドロップで位置の調整ができます。<p>
<div id='map'></div>

<style>
#map {
  height: 600px;
  width: 600px;
}
</style>

<script>
  let map;
  let marker;
  let geocoder;

  function initMap() {
    geocoder = new google.maps.Geocoder();

    map = new google.maps.Map(document.getElementById('map'), {
      center:  {lat: <%= @place.latitude %>, lng: <%= @place.longitude %>},
      zoom: 15,
    });

    marker = new google.maps.Marker({
      map: map,
      position: {lat: <%= @place.latitude %>, lng: <%= @place.longitude %>},
      draggable: true
    });

    google.maps.event.addListener(marker, 'dragend', function(ev){
      document.getElementById('lat').value = ev.latLng.lat();
      document.getElementById('lng').value = ev.latLng.lng();
    });
  }

  function codeAddress() {
    let inputAddress = document.getElementById('address').value;
    geocoder.geocode({'address': inputAddress}, function(results, status) {
      if (status == 'OK') {
        if (marker) {
          marker.setMap(null);
        }
        map.setCenter(results[0].geometry.location);

        marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location,
          draggable: true
        });

        document.getElementById('lat').value = results[0].geometry.location.lat();
        document.getElementById('lng').value = results[0].geometry.location.lng();

        google.maps.event.addListener(marker, 'dragend', function(ev){
          document.getElementById('lat').value = ev.latLng.lat();
          document.getElementById('lng').value = ev.latLng.lng();
        });
      } else {
        alert('該当する結果がありませんでした：' + status);
      }
    });
  }
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap">
</script>
